import { loadDB, saveDB } from "./api.js";

let DB = { farms: {}, receivings: {} };

document.addEventListener("DOMContentLoaded", async () => {
  DB = await loadDB();
  DB.farms = DB.farms || {};
  DB.receivings = DB.receivings || {};

  renderFarms();
});

/****************************************
 * RENDER FARMS + PROGRESS
 ****************************************/
function renderFarms() {
  const tbody = document.querySelector("#farmsTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  Object.values(DB.farms).forEach(farm => {
    const receivedQty = calcFarmReceived(farm.code);
    const target = Number(farm.target || 0);
    const progress = target > 0 ? Math.round((receivedQty / target) * 100) : 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${farm.code}</td>
      <td>${farm.name}</td>
      <td>${farm.owner || ""}</td>
      <td>${farm.acres || 0}</td>
      <td>${target}</td>
      <td>
        ${receivedQty} كجم
        <div class="progress mt-1">
          <div class="progress-bar" style="width:${progress}%">
            ${progress}%
          </div>
        </div>
      </td>
      <td>
        <button class="btn btn-sm btn-danger" data-del="${farm.code}">
          حذف
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("[data-del]").forEach(btn => {
    btn.onclick = () => deleteFarm(btn.dataset.del);
  });
}

/****************************************
 * CALC RECEIVED PER FARM
 ****************************************/
function calcFarmReceived(farmCode) {
  return Object.values(DB.receivings)
    .filter(r => r.farmCode === farmCode)
    .reduce((sum, r) => sum + Number(r.qty || 0), 0);
}

/****************************************
 * SAVE FARM
 ****************************************/
document.getElementById("farmForm").addEventListener("submit", async e => {
  e.preventDefault();

  const farm = {
    code: farm_code.value.trim(),
    name: farm_name.value.trim(),
    owner: owner_name.value.trim(),
    acres: Number(acres.value || 0),
    target: Number(target.value || 0)
  };

  if (!farm.code || !farm.name) {
    alert("الكود والاسم إجباري");
    return;
  }

  DB.farms[farm.code] = farm;
  await saveDB(DB);

  e.target.reset();
  bootstrap.Modal.getInstance(
    document.getElementById("farmModal")
  ).hide();

  renderFarms();
});

/****************************************
 * DELETE FARM
 ****************************************/
async function deleteFarm(code) {
  if (!confirm("تأكيد الحذف؟")) return;
  delete DB.farms[code];
  await saveDB(DB);
  renderFarms();
}
